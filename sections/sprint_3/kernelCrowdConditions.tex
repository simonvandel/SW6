\subsection{Estimating Crowd Factors}
Using what we now know about kernel density estimation, we can now expand this to the four crowd factors presented in \cref{sec:related_work}. The calculations for these crowd factors have been developed by \citet{wirz2012inferring}. The main difference between the calculations done in their paper and this project is for pressure, which we will explain further.

\subsubsection{Density}
Since the kernel 

\sinote*{brug det her et sted}{We assume that each person has the same density. This is done since we do not currently have a way to find the area each person takes up. This is also a reasonable assumption, and one that most crowd safety literature makes. As long as we keep the densities on 1 for the general formulas, any deviating values for the factor can simply be multiplied on the function.}

\subsubsection{Velocity}
The local crowd velocity is essentially calculated as in \citet{wirz2012inferring}. Here we use each persons velocity as the intensity of the kernel density estimation. Since we do not want the summed velocity of all people but rather the mean velocity, we divide by the kernel density sum. We diverge from Franke et al. by using a relative kernel function instead of a probabilistic. Assuming that the velocity is on relative form (meters per second) both the relative and probabilistic kernel density function will give a relative local crowd velocity. This is because we divide with the kernel density sum.
\begin{equation}
\label{eq:}
\vv{V_x} = \frac{\frac{2}{\pi \cdot h^2} \cdot \sum_{i=1}^N \vv{v_i} \cdot \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}{\frac{2}{\pi \cdot h^2} \cdot \sum_{i=1}^N \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}
\end{equation}

The function can be reduced to:

\begin{equation}
\label{eq:}
\vv{V_x} = \frac{\sum_{i=1}^N \vv{v_i} \cdot \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}{\sum_{i=1}^N \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}
\end{equation}

\subsubsection{Turbulence}
Turbulence is calculated from the heading direction rather than the velocity, as explained in \cref{sub:crowdFactorTurbulence}. In order to do this, we require a way to represent a direction. Following the method of \citet{localTrendStatistics}, we choose to represent direction as an angle, since direction in inherently cyclic. However the cyclic nature of angles provides an obstacle when we wish to find the average direction. In \cref{fig:radiansHeadingdirection} the problem is illustrated.


\begin{figure}\centering
\begin{tikzpicture}[scale=3]
\draw[->] (-1.2,0) to (1.2,0) node[anchor=west] {$x$};
\draw[->] (0,-1.2) to (0,1.2) node[anchor=south] {$y$};
\draw (1,0) node[anchor=north west] {$0$};
\draw (0,1) node[anchor=south east] {$\frac{\pi}{2}$};
\draw (-1,0) node[anchor=north east] {$\pi$};
\draw (0,-1) node[anchor=north east] {$\frac{3\pi}{2}$};

\coordinate (Right) at (1,0);
\coordinate (Center) at (0,0);
\circoord {0}{0}{1}{-45} {A};
\circoord {0}{0}{1}{-40} {B};
\circoord {0}{0}{1}{-35} {C};
\circoord {0}{0}{1}{-30} {D};
\circoord {0}{0}{1}{30} {E};
\circoord {0}{0}{1}{35} {F};
\circoord {0}{0}{1}{40} {G};
\circoord {0}{0}{1}{45} {H};
\circoord {0}{0}{1}{180} {I};

\draw[dashed] (Center) -- (A);
\draw[dashed] (Center) -- (B);
\draw[dashed] (Center) -- (C);
\draw[dashed] (Center) -- (D);
\draw[dashed] (Center) -- (E);
\draw[dashed] (Center) -- (F);
\draw[dashed] (Center) -- (G);
\draw[dashed] (Center) -- (H);
\draw[dashed, line width=2pt] (Center) -- (I);

\draw[fill] (A) circle (0.5pt);
\draw[fill] (B) circle (0.5pt);
\draw[fill] (C) circle (0.5pt);
\draw[fill] (D) circle (0.5pt);
\draw[fill] (E) circle (0.5pt);
\draw[fill] (F) circle (0.5pt);
\draw[fill] (G) circle (0.5pt);
\draw[fill] (H) circle (0.5pt);
\draw (I) circle (1pt) node[anchor=south west] {Mean};

\draw (Right) arc (0:360:1);
\end{tikzpicture}
\caption{Example of heading directions in a cyclic coordinate system}
\label{fig:radiansHeadingdirection}
\end{figure}

If we were to summarise the 8 heading directions marked with black dots, and find the mean direction, we would get $\pi$ instead of the desired direction of $0$. This problem was introduced and solved by \citet{localTrendStatistics}. Their solution is to denote the angle as a complex number with magnitude $1$. This would overcome the problem of the cyclic nature of angles, and allow us to find the desired mean direction. While this could have also been done with a two dimensional vector, we chose to keep with the complex numbers of the original solution, partly in order to better differentiate from velocity and also since the a vector would have implied not only direction but also speed.

Using this solution the mean direction would be found with this formula: $$\frac{\sum_{i=1}^{N} z_i}{N}$$ Where $z_i$ is the heading direction for person $i$.

In order to apply this in our system, we need to adjust the heading directions according to their kernel values. But before we do this, we have to consider a special case. Recalling our definition from \cref{subsubsec:headingDirection}, a persons heading direction is the average angle across his previous observed positions. Since we can not possibly observe infinitely many previous positions, it is possible that a person, who have been standing still for a while, has no defined heading direction.In order to best account for this, we must consider a still standing persons influence on the turbulence of an area.

Consider an area where everybody are standing still. This should be considered the opposite of a turbulent area, suggesting that a still standing person should contribute to less turbulence in an area.

However, an area where everybody is moving in a uniform direction, the introduction of still standing people would surely increase the turbulence of that area.

These two conflicting observations makes it impossible to perfectly evaluate a still standing persons influence on turbulence, without considering the context. Therefore we choose to remove any still standing people from our turbulence calculations, on the assumption that the remaining peoples heading direction will adequately represent the turbulence levels. This does leave us vulnerable to scenarios where everybody is standing still, except for two people, who happen to be moving in opposite  directions. However considering the low possibility of this situation persisting across multiple analysis runs, we accept this vulnerability.

All these considerations leaves us with this formula for calculating turbulence, where $N'$ is the number of people with a heading direction:

\begin{equation}
\label{eq:}
T_x = 1 - \left|\frac{\frac{2}{\pi \cdot h^2} \cdot \sum_{i=1}^{N'} z_i \cdot \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}{\frac{2}{\pi \cdot h^2} \cdot \sum_{i=1}^{N'} \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}\right|
\end{equation}

\begin{equation}
\label{eq:}
T_x = 1 - \left|\frac{\sum_{i=1}^{N'} z_i \cdot \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}{\sum_{i=1}^{N'} \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}\right|
\end{equation}

The formula works by summarising the individual heading directions and normalising them, in order to find the average heading direction. With each heading direction having a magnitude of $1$, the normalised summation will have a magnitude between $0$ and $1$ depending on the uniformity, with $1$ being a completely uniform heading direction. We then subtract this from $1$, such that a high uniformity will result in a low turbulence level.


\subsubsection{Pressure}
Pressure is a bit different. The factor was originally introduced by \citet{empircalstudy} as 

\begin{equation}
D_x \cdot \text{var}(\vv{V_x})
\end{equation}

where $D_x$ is the local crowd density and $\text{var}(\vv{V_x})$ is the variance in the local crowd velocity. We use the density found in \cref{sub:kernelDensityEstimation} and multiply it with the variance introduced by \citet{wirz2012inferring}

\begin{equation}
\label{eq:}
P_x = D_x \cdot \frac{\frac{2}{\pi \cdot h^2} \cdot \sum_{i=1}^{N} \left|\vv{v_i} - \vv{V_x}\right|^2 \cdot \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}{\frac{2}{\pi \cdot h^2} \cdot \sum_{i=1}^{N} \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}
\end{equation}
\begin{equation}
\label{eq:}
P_x = D_x \cdot \frac{\sum_{i=1}^{N} \left|\vv{v_i} - \vv{V_x}\right|^2 \cdot \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}{\sum_{i=1}^{N} \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}
\end{equation}

The main difference between this and the solution from Franke et al. is that our density is relative and not probabilistic, meaning that the result will also be relative rather than probabilistic. \Citet{empircalstudy} did not only introduce the factor, but also recorded data and pressure in relative values from the incident during the Hajj on the 12th of January 2006\cite{website:Wikipedia-Hajj}. This means that we can compare our results for local crowd pressure with the limits and high pressure found from real world incidents.



%this will be used later in \jenote{referer til det sted hvor vi s√¶tter gradienten for pres og potentiel warning layer}.










