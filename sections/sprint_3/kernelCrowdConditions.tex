\sinote{mangler at beskrive hvordan vi bruger intensitet variablen i density og velocity, pressure og turbulens. Der mangler måske også en extension til velocity, pressure og turbulens}

\subsection{Velocity, turbulence and pressure}
This section will expand the function for kernel density estimation, found in the previous section, to functions for calculating the local crowd velocity, turbulence and pressure, the three last factors found for detecting the local crowd condition. The calculations for these crowd factors have been developed by \citet{wirz2012inferring}. The main difference between the calculations done in their paper and this project is in pressure. 

\subsubsection{Velocity}
The local crowd velocity is essentially calculated as in \citet{wirz2012inferring}. Here we use each persons velocity as the intensity of the kernel density estimation. Since we do not want the summed velocity of all people but rather the mean velocity, we divide by the kernel density sum. We use diverge from Franke et al by using relative kernel function instead of a probabilistic. Assuming that the velocity is on relative form (meters per second) both the relative and probabilistic kernel density function will give a relative local crowd velocity. This is because we divide with the kernel density sum. 
\begin{equation}
\label{eq:}
\vv{V_x} = \frac{\frac{2}{\pi \cdot h^2} \cdot \sum_{i=1}^N \vv{v_i} \cdot \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}{\frac{2}{\pi \cdot h^2} \cdot \sum_{i=1}^N \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}
\end{equation}
The function can be reduced to:
\begin{equation}
\label{eq:}
\vv{V_x} = \frac{\sum_{i=1}^N \vv{v_i} \cdot \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}{\sum_{i=1}^N \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}
\end{equation}

\subsubsection{Turbulence}
Turbulence is calculated from the heading direction rather than the velocity, as explained in \cref{sub:crowdFactorTurbulence}. We need a way to represent a direction. When trying to find the mean heading direction a problem arises if we are using standard cyclic degrees or radians. The problem is best understood with an example. \Cref{fig:radiansHeadingdirection} illustrates the problem with radians.

\begin{figure}\centering
\begin{tikzpicture}[scale=3]
\draw[->] (-1.2,0) to (1.2,0) node[anchor=west] {$x$};
\draw[->] (0,-1.2) to (0,1.2) node[anchor=south] {$y$};
\draw (1,0) node[anchor=north west] {$0$};
\draw (0,1) node[anchor=south east] {$\frac{\pi}{2}$};
\draw (-1,0) node[anchor=north east] {$\pi$};
\draw (0,-1) node[anchor=north east] {$\frac{3\pi}{2}$};

\coordinate (Right) at (1,0);
\coordinate (Center) at (0,0);
\circoord {0}{0}{1}{-45} {A};
\circoord {0}{0}{1}{-40} {B};
\circoord {0}{0}{1}{-35} {C};
\circoord {0}{0}{1}{-30} {D};
\circoord {0}{0}{1}{30} {E};
\circoord {0}{0}{1}{35} {F};
\circoord {0}{0}{1}{40} {G};
\circoord {0}{0}{1}{45} {H};
\circoord {0}{0}{1}{180} {I};

\draw[dashed] (Center) -- (A);
\draw[dashed] (Center) -- (B);
\draw[dashed] (Center) -- (C);
\draw[dashed] (Center) -- (D);
\draw[dashed] (Center) -- (E);
\draw[dashed] (Center) -- (F);
\draw[dashed] (Center) -- (G);
\draw[dashed] (Center) -- (H);
\draw[dashed, line width=2pt] (Center) -- (I);

\draw[fill] (A) circle (0.5pt);
\draw[fill] (B) circle (0.5pt);
\draw[fill] (C) circle (0.5pt);
\draw[fill] (D) circle (0.5pt);
\draw[fill] (E) circle (0.5pt);
\draw[fill] (F) circle (0.5pt);
\draw[fill] (G) circle (0.5pt);
\draw[fill] (H) circle (0.5pt);
\draw (I) circle (1pt) node[anchor=south west] {Mean};

\draw (Right) arc (0:360:1);
\end{tikzpicture}
\caption{Example of heading directions in a cyclic coordinate system}
\label{fig:radiansHeadingdirection}
\end{figure}

Here we have 8 observations, 4 on each side of 0 radians pairwise equal distance from 0 radians. In this scenario we want the mean to be 0 radians, since this is the direction the people are generally heading, but if we calculate the mean, we get $\pi$, also illustrated in the figure. This problem was first introduced and solved by \citet{localTrendStatistics}. Their solution is \jenote{TODO: Explain how they calculate the directional mean via complex numbers instead of using simple mean and how it solves the problem}

\begin{equation}
\label{eq:}
T_x = 1 - \left|\frac{\frac{2}{\pi \cdot h^2} \cdot \sum_{i=1}^{N'} h_i \cdot \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}{\frac{2}{\pi \cdot h^2} \cdot \sum_{i=1}^{N'} \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}\right|
\end{equation}

\begin{equation}
\label{eq:}
T_x = 1 - \left|\frac{\sum_{i=1}^{N'} h_i \cdot \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}{\sum_{i=1}^{N'} \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}\right|
\end{equation}

\subsubsection{Pressure}
Pressure is a bit different. The fator were originally intruduced by \citet{empircalstudy} as 
\begin{equation}
D_x \cdot \text{var}(\vv{V_x})
\end{equation}
where $D_x$ is the local crowd density and $\text{var}\vv{V_x}$ is the variance in the local crowd velocity. We use the density found in \cref{sub:kernelDensityEstimation} and multiply it with the variance introduced by \citet{wirz2012inferring}
\begin{equation}
\label{eq:}
P_x = D_x \cdot \frac{\frac{2}{\pi \cdot h^2} \cdot \sum_{i=1}^{N} \left|\vv{v_i} - \vv{V_x}\right|^2 \cdot \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}{\frac{2}{\pi \cdot h^2} \cdot \sum_{i=1}^{N} \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}
\end{equation}
\begin{equation}
\label{eq:}
P_x = D_x \cdot \frac{\sum_{i=1}^{N} \left|\vv{v_i} - \vv{V_x}\right|^2 \cdot \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}{\sum_{i=1}^{N} \left(1-\left(\frac{d_{x,i}}{h}\right)^2 \cdot \mathbbm{1}_{\{|u| \leq 1\} }\right)}
\end{equation}
The main difference from this to Franke et al 2012 is that our density is relative and not probabilitylistic, meaning that the result will also be relative rather than probabilistic. \Citet{empircalstudy} did not only introduce the factor but also recorded data and pressure from an incident at \jenote{find lige ud af hvor og hvornår det uheld skete} in relative values. This means that we can in our system compare the results for specific areas with the limits and high pressure found from real world incidents, this will be used later in \jenote{referer til det sted hvor vi sætter gradienten for pres og potentiel warning layer}.